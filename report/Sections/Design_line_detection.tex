\documentclass[../Head/Main.tex]{subfiles}
\begin{document}

\subsubsection{Line detection}
It is usually important for a mobile robot to know its environment. There are several reasons for that, one is that robot must know the location of the obstacles (walls) relative to it to avoid driving into them. In the "bigworld" environment, the obstacles is walls which can be represented as lines from the filtered datapoints. These lines can be represented using a normal parametrization in polar coordinates, given by the following formula:
\begin{align}
    l:~~~~r = x\cdot\cos(\alpha)+y\cdot\sin(\alpha)
    \label{eq:line}
\end{align}
where $r$ represents the distance from the origin to the closest point on the line and $\alpha$ is the angle between the x-axis and the plane normal. \par
\begin{wrapfigure}{r}{6cm}
	\vspace{-12pt}
	\centering
	\subfile{../Figures/Orthogonal_distance_between_two_lines}
	\vspace{-5pt}
	\caption{Orthogonal distance from point $p_1$ to line $l$}
	\label{fig:orthogonal_distance}
	\vspace{-5pt}
\end{wrapfigure}
The Total Least Square method assumes that a line can be represented as in equation \ref{eq:line}. This method also involves a determination of the orthogonal distance (the shortest distance) from a point $p_i$ to a line $l$ as shown on  figure \ref{fig:orthogonal_distance}. The normal parametrization of the line $l_i$ is given by the following formula:
\begin{align}
    l_i:~~~~r_i = x_i\cdot\cos(\alpha)+y_i\cdot\sin(\alpha)
\end{align}
The separation between those two lines ($l$ and $l_i$) is given by the difference $d_i=r_i-r$, since both lines have the same $\alpha$. This means that the orthogonal distance can be described using the following formula:
\begin{align}
    d_i = x_i\cdot\cos(\alpha)+y_i\cdot\sin(\alpha) - r
\end{align}
This only applies if we assume that there is no noise on the measurements. \par
This method gives an solution to the problem of fitting a straight line to a dataset of points $p$ with $n$ measurements having errors. The problem of fitting a line can be determined using the following sum:
\begin{align}
    \chi^2\left(l, z_1, ..., z_n\right) = \sum_{i = 1}^{n} \left[\frac{\left(x_k - X_k\right)^2}{u_{x, k}^{2}} + \frac{\left(y_k - Y_k\right)^2}{u_{y, k}^{2}}\right]
\end{align}
where $(x_k,y_k)$ are the points coordinates with corresponding uncertainties $(u_{x, k},u_{y, k})$ and $(X_k,Y_k)$ denote its corresponding point of the straight line l. In the case of fitting the best line to the dataset, minimizes the expression for $\chi^2$ by setting $u_{x, k}=u_{y, k}=\sigma$ and $k=1,…,n$. This reduces the problem to the Total Least Square method and minimizing is equal to minimizing the orthogonal distance of the measurements to the fitting line. Therefore, in the case  of fitting the best line minimizes the expression above to the following:
\begin{align}
    \chi^2\left(l; Z\right) &= \sum_{i = 1}^{n} \frac{d_i^2}{\sigma^2} \\
    &= \sum_{i = 1}^{n}\frac{\left(x_i\cos(\alpha) + y_i\sin⁡(\alpha)-r\right)^2}{\sigma^2}\\
    &= \frac{1}{\sigma^2}\cdot\sum_{i = 1}^{n}\left(x_i\cos(\alpha) + y_i\sin⁡(\alpha)-r\right)^2
\end{align}
A condition for minimizing $\chi^2$ is done by solving the nonlinear equation system with respect to each of the two line parameters ($r$ and $\alpha$)
\begin{align}
    \frac{\partial\chi^2}{\partial r} = 0 \hspace{1.5cm} \frac{\partial\chi^2}{\partial\alpha} = 0
\end{align}
The solution of this nonlinear equation system is determined to the following:
\begin{align}
	r &= \overline{X}\cos(\alpha)+\overline{Y}\sin(\alpha) \\
    \alpha &= \frac{1}{2}\arctan\left(\frac{-2\sum_{i=1}^{n}\left[\left(x_i-\overline{X}\right) - \left(y_i-\overline{Y}\right)\right]}{\sum_{i = 1}^{n}\left[\left(x_i-\overline{X}\right)^2 - \left(y_i-\overline{Y}\right)^2\right]}\right)
\end{align}
where $\overline{x}$ and $\overline{y}$ are the means of $x$ and $y$. \par
As explained earlier, the two-wheeled robot should avoid obstacles (walls). To do so, the robot needs to know the location of the walls. It is done by processing the datapoints from the lidar scanner and determining the points which fits to a straight line using a line extraction algorithm. There are several different line extraction algorithms to choose from. The incremental line extraction algorithm is chosen, because it is simple to implement. The pseudo code for the incremental algorithm is shown below. \par
\begin{table}[H]
	\centering
	\begin{tabular}{c l}
		\hline
		\multicolumn{2}{l}{\textbf{Table							\ref{tab:Incremental}: Incremental Algorithm}}  			\\ \hline
		1 & Start by the first 2 points, construct a 				line \\
		2 & Add the next point to the current line model 		\\
		3 & Recompute the line parameters \\
		4 & If it satisfies line condition (go to 2) \\
		5 & Otherwise, put back the last point, 					recompute the line parameters, return the line  			\\
		6 & Continue to the next 2 points, go to 2 \\ 				\hline
	\end{tabular}
	\caption{Description of the Incremental algorithm}
	\label{tab:Incremental}
\end{table}
This algorithm implements the Total Least Square method then computing the line parameters. Furthermore, the line model consists of points, which all must comply some line conditions. In that case all points must comply these conditions. The first condition is a threshold for the angle between the previous and current line model as shown on figure \ref{fig:Line_model_angle}. The threshold is defined to be the following:
\begin{align*}
	\theta_{max} = 0,0025
\end{align*}
The second condition is the angle between two points relative to the robot location as shown on figure \ref{fig:Datapoints_angle}. This angle should be greater than this difference, but not twice as great, since this condition should separate the points into two lines, if one point is missing on the list as shown on figure \ref{fig:Line_separation}. This angle is therefore defined to be the following:
\begin{align*}
	\Delta\theta = \left(\theta_0 - \theta_1\right)\cdot 1,25
\end{align*}
\begin{figure}[H]
	\begin{subfigure}[b]{0.3\textwidth}
		\centering
		\subfile{../Figures/Angle_between_line_models}
		\caption{Illustration of the angle between current line model (blue line) and previous line model (red line)}
		\label{fig:Line_model_angle}
  	\end{subfigure}
  	\hfill
  	\begin{subfigure}[b]{0.3\textwidth}
  		\centering
		\subfile{../Figures/Angle_between_two_points}
		\caption{Illustration of the angle from horisontal to datapoint relative to the robot \\}
		\label{fig:Datapoints_angle}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.3\textwidth}
  		\centering
		\subfile{../Figures/Separating_two_lines}
		\caption{Illustration of the separation of to lines due to a missing datapoint \\}
		\label{fig:Line_separation}
	\end{subfigure}
  	\caption{Illustration of the angle between two datapoints and two line models}
\end{figure}
\end{document}